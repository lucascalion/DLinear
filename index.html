<!DOCTYPE html>
<html>

<head>
    <!-- Standard Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <!-- Site Properties -->
    <title>Homepage</title>
    <link rel="stylesheet" type="text/css" href="lib/semantic/semantic.min.css">
    <style type="text/css">

    </style>

    <script src="lib/jquery/jquery-3.1.0.min.js"></script>
    <script src="lib/semantic/semantic.min.js"></script>
    <script src="lib/easeljs/easeljs-0.8.2.min.js"></script>
    <script src="lib/preloadjs/preloadjs-0.6.2.min.js"></script>

    <script>
        var GRAD_SPEED = 0.15;
        var BAR_SPEED = 0.35;
        var env = {
            anim: 0,
            size: 500,
            coef: 0,
            start: false,
            curr: 0,
            max: 0
        };
        var bar_pos = {
            x: 219,
            y: 85
        };
        var metals = [{
            path: "images/barra_aco.png",
            coef: 22e-6,
        }, {
            path: "images/barra_cobre.png",
            coef: 17e-6,
        }, {
            path: "images/barra_latao.png",
            coef: 15e-6,
        }];
        var bg_offset = {
            x: 0,
            y: 0
        };
        var btn_targets = [{
            name: 'b',
            size: 500,
            x: 944,
            y: 256
        }, {
            name: 'c',
            size: 400,
            x: 806,
            y: 256
        }, {
            name: 'd',
            size: 300,
            x: 666,
            y: 256
        }];

        $(document)
            .ready(function() {

                var stage = new createjs.Stage("canvas");
                $("#scale").val("3");
                $("#scale").on("change", function() {
                    var children = stage.children;
                    for (var i = 0; i < children.length; i++) {
                        children[i].scaleX = children[i].scaleY = getScale($(this).val());
                    }
                });
                $("#btn_start").on("click", function() {
                    if (env.start)
                        return;
                    env.start = true;
                    disableControlls();
                });

                var bg_cointainer = new createjs.Container();

                var bar_container = new createjs.Container();
                var btn_container = new createjs.Container();
                bar_container.tickChildren = btn_container.tickChildren = bg_cointainer.tickChildren = false;
                var grad_container = new createjs.Container();
                stage.addChildAt(bg_cointainer, 0);
                stage.addChildAt(bar_container, 1);
                stage.addChildAt(btn_container, 2);
                stage.addChildAt(grad_container, 3);

                stage.mouseMoveOutside = true;
                var bg = new createjs.Bitmap("images/regua_experimento.png");
                bg_cointainer.y = 100;
                bg_cointainer.x = 6;
                bg_offset.y = bg_cointainer.y;
                bg_offset.x = bg_cointainer.x;
                bg_cointainer.addChild(bg);

                setupDragBtn(stage, btn_container)
                setupDragBar(stage, bar_container);
                setupDragGrad(stage, grad_container);

                createjs.Ticker.addEventListener("tick", function(event) {
                    stage.update(event);
                });

                $("#scale").trigger("change");
                $('#metal_type').trigger("change");
                $('#metal_size').trigger("change");

            });

        setupDragBtn = function(stage, layer) {
            var button = new createjs.Bitmap("images/btn.png");
            layer.addChild(button);
            $('#metal_size').on('change', function() {
                if (env.start)
                    return;
                var val = $(this).val();
                var point = btn_targets[val];
                layer.x = point.x;
                layer.y = point.y;
                env.size = point.size;
            });
            // return button;
            // var dragger_button = new createjs.Container();
            // dragger_button.addChild(button);
            // stage.addChild(dragger_button);
            // dragger_button.x = bg_offset.x + 936.5;
            // dragger_button.y = bg_offset.y + 157;
            // dragger_button.on("mousedown", function(evt) {
            //     if (true)
            //         return;
            //     var ct = evt.currentTarget,
            //         local = ct.globalToLocal(evt.stageX, evt.stageY),
            //         nx = ct.regX - local.x,
            //         ny = ct.regY - local.y;
            //     //set the new regX/Y
            //     ct.regX = local.x;
            //     ct.regY = local.y;
            //     //adjust the real-position, otherwise the new regX/Y would cause a jump
            //     ct.x -= nx;
            //     ct.y -= ny;
            // });
            //
            // dragger_button.on("pressmove", function(evt) {
            //     // currentTarget will be the container that the event listener was added to:
            //     evt.currentTarget.x = evt.stageX;
            //     evt.currentTarget.y = evt.stageY;
            //     console.log("Barra posX: " + evt.stageX + ", posY: " + evt.stageY);
            //     // make sure to redraw the stage to show the change:
            //     stage.update();
            // });
        };

        setupDragBar = function(stage, layer) {
            var bar = null;
            $('#metal_type').on('change', function() {
                if (env.start)
                    return;
                var val = $(this).val();
                var newImg = metals[val].path;
                if (bar) {
                    layer.removeChild(bar);
                }
                bar = new createjs.Bitmap(newImg);
                layer.addChild(bar);
                layer.x = bg_offset.x + bar_pos.x;
                layer.y = bg_offset.y + bar_pos.y;
                env.coef = metals[val].coef;
                //bar.scaleX = bar.scaleY = getScale($('#scale').val());
            });
            // var dragger_bar = new createjs.Container();
            // dragger_bar.addChild(bar);
            // stage.addChild(dragger_bar);
            // dragger_bar.x = 100;
            // dragger_bar.y = 100;
            // dragger_bar.on("mousedown", function(evt) {
            //   if(true) return;
            //     var ct = evt.currentTarget,
            //         local = ct.globalToLocal(evt.stageX, evt.stageY),
            //         nx = ct.regX - local.x,
            //         ny = ct.regY - local.y;
            //     //set the new regX/Y
            //     ct.regX = local.x;
            //     ct.regY = local.y;
            //     //adjust the real-position, otherwise the new regX/Y would cause a jump
            //     ct.x -= nx;
            //     ct.y -= ny;
            // });
            //
            // dragger_bar.on("pressmove", function(evt) {
            //     // currentTarget will be the container that the event listener was added to:
            //     evt.currentTarget.x = evt.stageX;
            //     evt.currentTarget.y = evt.stageY;
            //     console.log("Barra posX: " + evt.stageX + ", posY: " + evt.stageY);
            //     // make sure to redraw the stage to show the change:
            //     stage.update();
            // });
        };

        setupDragGrad = function(stage, layer) {
            var animMatrix = [{
                colors: ["#0000ff", "#b3b3ff"],
                ratio: [0, 1],
            }, {
                colors: ["#0000ff", "#b3b3ff", "#ffff00"],
                ratio: [0, 0.45, 1],
            }, {
                colors: ["#0000ff", "#b3b3ff", "#ffff00", "#cc0000"],
                ratio: [0, 0.30, 0.45, 1],
            }];
            var shape = new createjs.Shape();
            //Grad posX: 391, posY: 495.81766777941993
            var max_w = 1190,
                curr_w = 45;
            shape.graphics.drawRect(0, 0, curr_w, 47);
            shape.on("tick", function(event) {
                if (env.start) {
                    curr_w = Math.round(curr_w + event.delta * GRAD_SPEED);
                    curr_w = curr_w > 1190 ? 1190 : curr_w
                    var step = env.anim;
                    switch (step) {
                        case 0:
                            calcGradAnim(curr_w);
                            shape.graphics.clear();
                            shape.graphics.beginLinearGradientFill(animMatrix[step].colors, animMatrix[step].ratio, 0, 0, curr_w, 47);
                            shape.graphics.drawRect(0, 0, curr_w, 47);
                            shape.graphics.endFill();
                            break;
                        case 1:
                            calcGradAnim(curr_w);
                            shape.graphics.clear();
                            shape.graphics.beginLinearGradientFill(animMatrix[step].colors, animMatrix[step].ratio, 0, 0, curr_w, 47);
                            shape.graphics.drawRect(0, 0, curr_w, 47);
                            shape.graphics.endFill();
                            break;
                        default:
                            calcGradAnim(curr_w);
                            step = step > 2 ? 2 : step;
                            shape.graphics.clear();
                            shape.graphics.beginLinearGradientFill(animMatrix[step].colors, animMatrix[step].ratio, 0, 0, curr_w, 47);
                            shape.graphics.drawRect(0, 0, curr_w, 47);
                            shape.graphics.endFill();
                            //console.log(env.anim);
                            break;
                    }

                    if (env.anim > 2) {

                        if (env.curr == 0) {

                            env.curr = env.coef * env.size * 10;
                            env.max = env.coef * env.size * 68;
                            //console.log("Inicial curr:"+env.curr);
                        } else {
                            env.curr += (event.delta * BAR_SPEED) / 1000;
                            env.curr = env.curr > env.max ? env.max : env.curr;
                            //console.log("Curr:"+env.curr);
                        }
                        //set text
                        calcBarAnim(env.curr, env.max);

                        if (env.anim > 6) {
                            env.start = false;
                            curr_w = 45;
                            env.anim = 0;
                            env.curr = 0;
                            env.max = 0;
                            enableControlls();
                        }
                    }

                }
            });
            //shape.graphics.drawRect(0, 0, 1190, 47);
            layer.addChild(shape);
            layer.x = 391;
            layer.y = 495.81766777941993;
            //#0000ff, #b3b3ff
            //#ffff00, #cc0000
            // layer.on("mousedown", function(evt) {
            //     if (true) return;
            //     var ct = evt.currentTarget,
            //         local = ct.globalToLocal(evt.stageX, evt.stageY),
            //         nx = ct.regX - local.x,
            //         ny = ct.regY - local.y;
            //     //set the new regX/Y
            //     ct.regX = local.x;
            //     ct.regY = local.y;
            //     //adjust the real-position, otherwise the new regX/Y would cause a jump
            //     ct.x -= nx;
            //     ct.y -= ny;
            // });
            //
            // layer.on("pressmove", function(evt) {
            //     // currentTarget will be the container that the event listener was added to:
            //     evt.currentTarget.x = evt.stageX;
            //     evt.currentTarget.y = evt.stageY;
            //     console.log("Grad posX: " + evt.stageX + ", posY: " + evt.stageY);
            //     // make sure to redraw the stage to show the change:
            //     stage.update();
            // });
        };

        disableControlls = function() {
          $(".controll").prop('disabled', true);
        };

        enableControlls = function() {
          $(".controll").prop('disabled', false);
        };

        calcGradAnim = function(w) {
            if (w >= 1190) {
                env.anim = env.anim == 2 ? 3 : env.anim;
                return;
            }

            if (w < (1190 * 30 / 100)) {
                env.anim = 0;
            } else if (w > (1190 * 30 / 100) && w < (1190 * 60 / 100)) {
                env.anim = 1;
            } else if (w > (1190 * 60 / 100)) {
                env.anim = 2;
            }

        };

        calcBarAnim = function(curr, max) {
            if (curr >= max) {
                env.anim = 7;
            }

        };

        getScale = function(s) {
            switch (s) {
                case '0':
                    return 0.09;
                default:
                    return parseFloat(s) / 10;
            }
        }
    </script>
</head>

<body>
    <div class="ui container">
        <div class="ui three columns grid">
            <div class="ui row">
                <div class="ui column">
                    <label for="metal_type" class="ui label">Tipo de Metal</label>
                    <select id="metal_type" class="ui dropdown controll">
                    <option value="1">Cobre</option>
                    <option value="2">Ouro</option>
                    <option value="0">Alumínio</option>
                  </select>
                </div>
                <div class="ui column">
                    <label for="metal_size" class="ui label">Tamanho da Barra</label>
                    <select id="metal_size" class="ui dropdown controll">
                    <option value="0">500mm</option>
                    <option value="1">400mm</option>
                    <option value="2">300mm</option>
                  </select>
                </div>
                <div class="ui column" style="display:none">
                    <label for="scale" class="ui label">Escala</label>
                    <select id="scale" class="ui dropdown controll">
                    <option value="0">9%</option>
                    <option value="1">10%</option>
                    <option value="2">20%</option>
                    <option value="3">30%</option>
                    <option value="4">40%</option>
                    <option value="5">50%</option>
                    <option value="6">60%</option>
                    <option value="7">70%</option>
                    <option value="8">80%</option>
                    <option value="9">90%</option>
                    <option value="10">100%</option>
                  </select>
                </div>
                <div class="ui column">
                    <button class="ui primary button controll" id="btn_start" type="button" name="start">Iniciar</button>
                </div>
            </div>
            <div class="ui two column row">
                <canvas id="canvas" width="1150" height="600" style="border: 1px solid black;"></canvas>
            </div>
        </div>


    </div>
</body>

</html>
